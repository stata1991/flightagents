<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripPlanner.ai - Ultimate Travel Experience</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1E3A8A 0%, #7C3AED 100%);
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            /* Enhanced travel feel with subtle animation */
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Enhanced Travel Container */
        .travel-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: relative;
            overflow-x: hidden;
            overflow-y: visible;
            max-width: 100%;
            width: 100%;
        }

        .travel-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="travel-pattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="%231E3A8A" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23travel-pattern)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        /* Enhanced Header with Travel Feel */
        .travel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            box-shadow: 0 4px 20px rgba(30, 58, 138, 0.3);
        }

        .travel-agent-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .travel-agent-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFFFFF, #E0E7FF);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1E3A8A;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .travel-agent-name {
            font-weight: 700;
            font-size: 18px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .travel-agent-subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* Enhanced Chat Area */
        .travel-chat-area {
            flex: 1;
            overflow-y: visible;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            min-height: auto;
        }

        /* Enhanced Message Styling */
        .travel-message {
            max-width: 85%;
            padding: 18px 22px;
            border-radius: 24px;
            margin: 8px 0;
            position: relative;
            animation: messageSlideIn 0.4s ease-out;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        .travel-message:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .travel-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #3B82F6, #1E3A8A);
            color: white;
            border-bottom-right-radius: 12px;
        }

        .travel-message.ai {
            align-self: flex-start;
            background: linear-gradient(135deg, #FFFFFF, #F8FAFC);
            color: #1F2937;
            border-bottom-left-radius: 12px;
            border-left: 5px solid #3B82F6;
        }

        .travel-message.ai::before {
            content: 'üó∫Ô∏è';
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 3px solid #3B82F6;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(25px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Enhanced Quick Reply Buttons */
        .travel-quick-replies {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .travel-quick-replies::-webkit-scrollbar {
            display: none;
        }

        .travel-quick-reply {
            padding: 12px 20px;
            background: linear-gradient(135deg, #FFFFFF, #F1F5F9);
            border: 2px solid #E2E8F0;
            border-radius: 25px;
            color: #1F2937;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .travel-quick-reply:hover {
            background: linear-gradient(135deg, #3B82F6, #1E3A8A);
            color: white;
            border-color: #3B82F6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        /* Interest-Based Planning Section */
        .interest-planning-section {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            margin: 20px 0;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .interest-planning-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .interest-planning-header h3 {
            color: #1E3A8A;
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .interest-planning-header p {
            color: #64748B;
            font-size: 1.1rem;
        }

        .interest-planning-step {
            margin-bottom: 40px;
        }

        .interest-planning-step:last-child {
            margin-bottom: 20px;
        }

        .planning-step h4 {
            color: #1E3A8A;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .interest-options, .season-options, .celebration-options, 
        .business-options, .leisure-options, .hotel-preferences {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .interest-option, .season-option, .celebration-option, 
        .business-option, .leisure-option, .hotel-preference {
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .interest-option:hover, .season-option:hover, .celebration-option:hover,
        .business-option:hover, .leisure-option:hover, .hotel-preference:hover {
            border-color: #3B82F6;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
        }

        .interest-option.selected, .season-option.selected, .celebration-option.selected,
        .business-option.selected, .leisure-option.selected, .hotel-preference.selected {
            border-color: #3B82F6;
            background: linear-gradient(135deg, #3B82F6, #1E3A8A);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .interest-option i, .season-option i, .celebration-option i,
        .business-option i, .leisure-option i, .hotel-preference i {
            font-size: 2rem;
            color: #3B82F6;
        }

        .interest-option.selected i, .season-option.selected i, .celebration-option.selected i,
        .business-option.selected i, .leisure-option.selected i, .hotel-preference.selected i {
            color: white;
        }

        .interest-option span, .season-option span, .celebration-option span,
        .business-option span, .leisure-option span, .hotel-preference span {
            font-weight: 600;
            font-size: 1rem;
        }

        .interest-option small, .season-option small, .celebration-option small,
        .business-option small, .leisure-option small, .hotel-preference small {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .interest-planning-progress {
            margin: 30px 0;
            text-align: center;
        }

        .interest-progress-bar {
            width: 100%;
            height: 8px;
            background: #E2E8F0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .interest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3B82F6, #1E3A8A);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 20%;
        }

        .interest-progress-text {
            color: #64748B;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .interest-planning-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .interest-planning-nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .interest-planning-nav-btn.primary {
            background: linear-gradient(135deg, #3B82F6, #1E3A8A);
            color: white;
        }

        .interest-planning-nav-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .interest-planning-nav-btn.secondary {
            background: transparent;
            color: #64748B;
            border: 2px solid #E2E8F0;
        }

        .interest-planning-nav-btn.secondary:hover {
            border-color: #3B82F6;
            color: #3B82F6;
        }

        /* Content Container for better organization */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            box-sizing: border-box;
            height: auto;
            overflow: visible;
        }

        /* Content Container for better organization */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            padding: 0 20px;
        }

        /* Enhanced Input Area */
        .travel-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #E2E8F0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .travel-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .travel-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #E2E8F0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: #F8FAFC;
        }

        .travel-input:focus {
            border-color: #3B82F6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .travel-input:disabled {
            background: #F1F5F9;
            color: #94A3B8;
            cursor: not-allowed;
            border-color: #E2E8F0;
        }

        .travel-input:disabled::placeholder {
            color: #94A3B8;
        }

        .travel-send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #3B82F6, #1E3A8A);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .travel-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .travel-send-btn:disabled {
            background: #94A3B8;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(148, 163, 184, 0.2);
        }

        .travel-send-btn:disabled:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(148, 163, 184, 0.2);
        }

        /* Enhanced Itinerary Display */
        .travel-itinerary {
            background: white;
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            margin: 16px 0;
            animation: itinerarySlideIn 0.6s ease-out;
        }

        @keyframes itinerarySlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .travel-itinerary-header {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .travel-itinerary-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .travel-itinerary-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Travel Route Animation */
        .travel-route-animation {
            background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
            padding: 20px;
            border-bottom: 1px solid #E2E8F0;
        }

        .world-map-container {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
        }

        .travel-map {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Custom map markers */
        .custom-marker {
            background: #3B82F6;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .origin-marker {
            background: #10B981;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .destination-marker {
            background: #F59E0B;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .flight-path {
            stroke: #F59E0B;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            fill: none;
            animation: dash 2s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -15;
            }
        }

        .airplane-marker {
            background: #EF4444;
            border: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        .route-info {
            text-align: center;
            margin-top: 12px;
        }

        .route-text {
            color: #1E40AF;
            font-weight: 600;
            font-size: 14px;
        }

        .origin-city, .destination-city {
            color: #3B82F6;
            font-weight: 700;
        }

        .travel-itinerary-tabs {
            display: flex;
            background: #F8FAFC;
            border-bottom: 1px solid #E2E8F0;
        }

        .travel-tab-btn {
            flex: 1;
            padding: 16px 20px;
            border: none;
            background: transparent;
            color: #64748B;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .travel-tab-btn.active {
            color: #1E3A8A;
            background: white;
        }

        .travel-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #3B82F6, #1E3A8A);
        }

        .travel-tab-content {
            padding: 24px;
            display: none;
        }

        .travel-tab-content.active {
            display: block;
        }

        /* Enhanced Day Cards */
        .travel-day-card {
            background: linear-gradient(135deg, #F8FAFC, #F1F5F9);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            border-left: 5px solid #3B82F6;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .travel-day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .travel-day-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .travel-day-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6, #1E3A8A);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .travel-day-title {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
        }

        .travel-day-theme {
            font-size: 14px;
            color: #64748B;
            font-style: italic;
        }

        .travel-activity {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid #10B981;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .travel-activity-time {
            font-size: 12px;
            color: #64748B;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .travel-activity-title {
            font-size: 16px;
            font-weight: 700;
            color: #1F2937;
            margin: 4px 0;
        }

        .travel-activity-description {
            font-size: 14px;
            color: #4B5563;
            line-height: 1.5;
            margin: 8px 0;
        }

        .travel-activity-tips {
            background: #FEF3C7;
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 12px;
            color: #92400E;
        }

        /* Enhanced Flight/Hotel Cards */
        .travel-option-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border: 2px solid #E2E8F0;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        .travel-option-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 8px;
        }
        .travel-option-price {
            font-weight: 700;
            color: #1F2937;
            text-align: right;
            min-width: 80px;
        }
        .travel-book-btn {
            display: inline-block;
            margin-left: auto;
            margin-top: 8px;
            background: #10B981;
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            padding: 10px 24px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }
        .travel-book-btn:hover {
            background: #059669;
        }

        /* Enhanced Loading Animation */
        .travel-loading {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 24px;
            background: linear-gradient(135deg, #F8FAFC, #F1F5F9);
            border-radius: 16px;
            margin: 16px 0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .travel-loading-spinner {
            width: 32px;
            height: 32px;
            border: 4px solid #E2E8F0;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .travel-loading-text {
            color: #1F2937;
            font-weight: 600;
        }

        .travel-loading-subtext {
            color: #64748B;
            font-size: 14px;
            margin-top: 4px;
        }

        /* Agentic AI Workflow Animation */
        .agentic-workflow {
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            border-radius: 20px;
            margin: 15px 0;
            padding: 25px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .agentic-workflow::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        .workflow-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .workflow-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .workflow-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .agents-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .agent-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .agent-card.active {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .agent-card.completed {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
        }

        .agent-card.error {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .agent-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .agent-avatar.flight { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .agent-avatar.hotel { background: linear-gradient(135deg, #10b981, #059669); }
        .agent-avatar.budget { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .agent-avatar.destination { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .agent-info h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .agent-info p {
            font-size: 0.85rem;
            opacity: 0.8;
            margin: 0;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6b7280;
            animation: pulse 2s infinite;
        }

        .status-indicator.working {
            background: #3b82f6;
            animation: pulse 1s infinite;
        }

        .status-indicator.completed {
            background: #10b981;
            animation: none;
        }

        .status-indicator.error {
            background: #ef4444;
            animation: none;
        }

        .status-text {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 2px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .agent-details {
            margin-top: 12px;
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .completion-message {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(34, 197, 94, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .completion-message h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: #10b981;
        }

        .completion-message p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Mobile responsiveness for agentic workflow */
        @media (max-width: 768px) {
            .agents-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .agent-card {
                padding: 15px;
            }
            
            .workflow-title {
                font-size: 1.1rem;
            }
            
            .agentic-workflow {
                padding: 20px;
                margin: 10px 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .travel-message {
                max-width: 90%;
                padding: 16px 18px;
            }

            .travel-quick-replies {
                padding: 12px 16px;
            }

            .travel-quick-reply {
                padding: 10px 16px;
                font-size: 13px;
            }

            .travel-input {
                padding: 14px 18px;
                font-size: 16px;
            }

            .travel-itinerary-header {
                padding: 20px;
            }

            .travel-itinerary-title {
                font-size: 20px;
            }
        }

        /* Accessibility */
        .travel-message:focus,
        .travel-quick-reply:focus,
        .travel-input:focus,
        .travel-send-btn:focus {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .travel-message.ai {
                border-left-width: 6px;
            }
            
            .travel-day-card {
                border-left-width: 6px;
            }
        }
        /* Force chat area and itinerary to always be visible and scrollable */
        #travelChatArea {
            min-height: 400px;
            max-height: none;
            height: auto;
            overflow-y: visible !important;
            display: flex;
            flex-direction: column;
        }
        .travel-itinerary {
            min-height: 300px !important;
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }
        .travel-itinerary * {
            color: inherit !important;
        }
        .travel-quick-replies {
            position: static;
            margin-bottom: 0;
        }

        /* Location Discovery Styles */
        .location-discovery-section {
            background: white;
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            overflow: visible;
            margin: 20px 0;
            display: block;
            animation: slideInUp 0.5s ease-out;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            box-sizing: border-box;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .location-discovery-header {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            padding: 24px;
            text-align: center;
        }

        .location-discovery-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .location-discovery-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .location-consent-section {
            padding: 32px;
            background: #F8FAFC;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: visible;
            margin-bottom: 20px;
        }

        .location-consent-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .location-consent-header h3 {
            font-size: 24px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .location-consent-header p {
            font-size: 16px;
            color: #6B7280;
            margin: 0;
        }

        .location-consent-options {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
            gap: 24px !important;
            margin-bottom: 24px !important;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        @media (max-width: 768px) {
            .location-consent-options {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
        }

        .location-option {
            background: white !important;
            border-radius: 16px !important;
            padding: 24px !important;
            border: 2px solid #E2E8F0 !important;
            transition: all 0.3s ease !important;
            text-align: left !important;
            display: block !important;
            width: 100% !important;
            box-sizing: border-box !important;
            min-height: 200px !important;
            position: relative !important;
        }

        .location-option:hover {
            border-color: #3B82F6;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .location-option-icon {
            font-size: 32px;
            margin-bottom: 16px;
            text-align: center;
        }

        .location-option-content h4 {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .location-option-content p {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .location-consent-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin: 20px 0;
        }

        .location-btn {
            padding: 12px 24px !important;
            border: none !important;
            border-radius: 25px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            display: inline-block !important;
            text-decoration: none !important;
            text-align: center !important;
            min-width: 120px !important;
        }

        .location-btn-primary {
            background: linear-gradient(45deg, #3B82F6, #1E3A8A);
            color: white;
        }

        .location-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .location-btn-secondary {
            background: #F1F5F9;
            color: #1F2937;
            border: 2px solid #E2E8F0;
        }

        .location-btn-secondary:hover {
            background: #E2E8F0;
            transform: translateY(-2px);
        }

        .location-info {
            background: #E3F2FD;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            display: none;
        }

        .location-info.show {
            display: block;
        }

        .destination-filters {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #E2E8F0;
        }

        .filter-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3B82F6;
        }

        .destination-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            padding: 24px;
            background: #F8FAFC;
        }

        .destination-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid #E2E8F0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .destination-card:hover {
            border-color: #3B82F6;
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.15);
            transform: translateY(-4px);
        }

        .destination-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3B82F6, #1E3A8A);
        }

        .destination-card h3 {
            color: #1F2937;
            margin-bottom: 8px;
            font-size: 20px;
            font-weight: 700;
        }

        .destination-card .type {
            color: #3B82F6;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            font-size: 12px;
            background: #E3F2FD;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .destination-card .highlights {
            color: #4B5563;
            font-size: 14px;
        }

        .destination-card .highlights ul {
            list-style: none;
            padding: 0;
            margin: 12px 0 0 0;
        }

        .destination-card .highlights li {
            padding: 6px 0;
            color: #6B7280;
            position: relative;
            padding-left: 20px;
        }

        .destination-card .highlights li::before {
            content: '‚ú®';
            position: absolute;
            left: 0;
            top: 6px;
        }

        .destination-card .highlights li:last-child {
            border-bottom: none;
        }

        .data-source-info {
            background: #E3F2FD;
            color: #1976D2;
            padding: 12px 24px;
            text-align: center;
            font-size: 14px;
        }

        .destination-loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 16px;
            border: 2px solid #E2E8F0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #E2E8F0;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .destination-loading p {
            color: #6B7280;
            font-size: 16px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="travel-container">
        <!-- Enhanced Travel Header -->
        <div class="travel-header">
            <div class="travel-agent-info">
                <div class="travel-agent-avatar">üó∫Ô∏è</div>
                <div>
                    <div class="travel-agent-name">Travel Expert</div>
                    <div class="travel-agent-subtitle">Your Personal Journey Guide</div>
                </div>
            </div>
        </div>

        <!-- Enhanced Chat Area -->
        <div class="travel-chat-area" id="travelChatArea">
            <!-- Messages will be dynamically added here -->
        </div>

        <!-- Content Container for better organization -->
        <div class="content-container">

        <!-- Enhanced Quick Replies with Interest-Based Planning -->
        <div class="travel-quick-replies" id="travelQuickReplies" style="display: none;">
            <!-- Quick reply buttons will be dynamically added here -->
        </div>

        <!-- Conversational Interest Planning - Integrated into chat flow -->
        <div class="conversational-interests" id="conversationalInterests" style="display: none;">
            <div class="conversational-interests-content">
                <h3>üéØ Let's Get to Know Your Travel Style</h3>
                <p>I'll ask you a few questions to personalize your trip recommendations</p>
            
            <!-- Quick Interest Buttons for Common Scenarios -->
            <div class="interest-quick-buttons">
                <button class="interest-quick-btn" onclick="enhancedTravelInterface.askTripType()">
                    <i class="fas fa-question-circle"></i>
                    <span>What type of trip?</span>
                </button>
                <button class="interest-quick-btn" onclick="enhancedTravelInterface.askOccasion()">
                    <i class="fas fa-gift"></i>
                    <span>Special occasion?</span>
                </button>
                <button class="interest-quick-btn" onclick="enhancedTravelInterface.askInterests()">
                    <i class="fas fa-heart"></i>
                    <span>What interests you?</span>
                </button>
                <button class="interest-quick-btn" onclick="enhancedTravelInterface.askAccommodation()">
                    <i class="fas fa-bed"></i>
                    <span>Accommodation preferences?</span>
                </button>
            </div>

            <!-- Seasonal Planning -->
            <div class="interest-planning-step" id="seasonalStep" style="display: none;">
                <h4>When do you want to travel?</h4>
                <div class="season-options">
                    <button class="season-option" data-season="summer" onclick="enhancedTravelInterface.selectSeason('summer')">
                        <i class="fas fa-sun"></i>
                        <span>Summer</span>
                        <small>June - August</small>
                    </button>
                    <button class="season-option" data-season="winter" onclick="enhancedTravelInterface.selectSeason('winter')">
                        <i class="fas fa-snowflake"></i>
                        <span>Winter</span>
                        <small>December - February</small>
                    </button>
                    <button class="season-option" data-season="spring" onclick="enhancedTravelInterface.selectSeason('spring')">
                        <i class="fas fa-seedling"></i>
                        <span>Spring</span>
                        <small>March - May</small>
                    </button>
                    <button class="season-option" data-season="fall" onclick="enhancedTravelInterface.selectSeason('fall')">
                        <i class="fas fa-leaf"></i>
                        <span>Fall</span>
                        <small>September - November</small>
                    </button>
                </div>
            </div>

            <!-- Celebration Planning -->
            <div class="interest-planning-step" id="celebrationStep" style="display: none;">
                <h4>What are you celebrating?</h4>
                <div class="celebration-options">
                    <button class="celebration-option" data-celebration="birthday" onclick="enhancedTravelInterface.selectCelebration('birthday')">
                        <i class="fas fa-birthday-cake"></i>
                        <span>Birthday</span>
                    </button>
                    <button class="celebration-option" data-celebration="anniversary" onclick="enhancedTravelInterface.selectCelebration('anniversary')">
                        <i class="fas fa-heart"></i>
                        <span>Anniversary</span>
                    </button>
                    <button class="celebration-option" data-celebration="honeymoon" onclick="enhancedTravelInterface.selectCelebration('honeymoon')">
                        <i class="fas fa-ring"></i>
                        <span>Honeymoon</span>
                    </button>
                    <button class="celebration-option" data-celebration="babymoon" onclick="enhancedTravelInterface.selectCelebration('babymoon')">
                        <i class="fas fa-baby"></i>
                        <span>Babymoon</span>
                    </button>
                    <button class="celebration-option" data-celebration="bachelor" onclick="enhancedTravelInterface.selectCelebration('bachelor')">
                        <i class="fas fa-glass-cheers"></i>
                        <span>Bachelor Party</span>
                    </button>
                </div>
            </div>

            <!-- Business Trip Planning -->
            <div class="interest-planning-step" id="businessStep" style="display: none;">
                <h4>What's your business travel priority?</h4>
                <div class="business-options">
                    <button class="business-option" data-priority="downtown" onclick="enhancedTravelInterface.selectBusinessPriority('downtown')">
                        <i class="fas fa-building"></i>
                        <span>Downtown Location</span>
                        <small>Close to business district</small>
                    </button>
                    <button class="business-option" data-priority="airport" onclick="enhancedTravelInterface.selectBusinessPriority('airport')">
                        <i class="fas fa-plane"></i>
                        <span>Airport Proximity</span>
                        <small>Easy access to flights</small>
                    </button>
                    <button class="business-option" data-priority="office" onclick="enhancedTravelInterface.selectBusinessPriority('office')">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Near Specific Office</span>
                        <small>Close to your workplace</small>
                    </button>
                    <button class="business-option" data-priority="flexible" onclick="enhancedTravelInterface.selectBusinessPriority('flexible')">
                        <i class="fas fa-balance-scale"></i>
                        <span>Flexible Location</span>
                        <small>Any convenient area</small>
                    </button>
                </div>
            </div>

            <!-- Leisure Planning -->
            <div class="interest-planning-step" id="leisureStep" style="display: none;">
                <h4>What interests you most?</h4>
                <div class="leisure-options">
                    <button class="leisure-option" data-interest="beach" onclick="enhancedTravelInterface.selectLeisureInterest('beach')">
                        <i class="fas fa-umbrella-beach"></i>
                        <span>Beach & Water</span>
                    </button>
                    <button class="leisure-option" data-interest="mountain" onclick="enhancedTravelInterface.selectLeisureInterest('mountain')">
                        <i class="fas fa-mountain"></i>
                        <span>Mountains & Nature</span>
                    </button>
                    <button class="leisure-option" data-interest="city" onclick="enhancedTravelInterface.selectLeisureInterest('city')">
                        <i class="fas fa-city"></i>
                        <span>City & Culture</span>
                    </button>
                    <button class="leisure-option" data-interest="adventure" onclick="enhancedTravelInterface.selectLeisureInterest('adventure')">
                        <i class="fas fa-hiking"></i>
                        <span>Adventure & Sports</span>
                    </button>
                    <button class="leisure-option" data-interest="relaxation" onclick="enhancedTravelInterface.selectLeisureInterest('relaxation')">
                        <i class="fas fa-spa"></i>
                        <span>Relaxation & Wellness</span>
                    </button>
                    <button class="leisure-option" data-interest="food" onclick="enhancedTravelInterface.selectLeisureInterest('food')">
                        <i class="fas fa-utensils"></i>
                        <span>Food & Dining</span>
                    </button>
                </div>
            </div>

            <!-- Hotel Preferences -->
            <div class="interest-planning-step" id="hotelPreferencesStep" style="display: none;">
                <h4>What's important for your accommodation?</h4>
                <div class="hotel-preferences">
                    <button class="hotel-preference" data-preference="proximity" onclick="enhancedTravelInterface.selectHotelPreference('proximity')">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Location Proximity</span>
                        <small>Close to attractions/offices</small>
                    </button>
                    <button class="hotel-preference" data-preference="luxury" onclick="enhancedTravelInterface.selectHotelPreference('luxury')">
                        <i class="fas fa-star"></i>
                        <span>Luxury & Comfort</span>
                        <small>Premium amenities</small>
                    </button>
                    <button class="hotel-preference" data-preference="budget" onclick="enhancedTravelInterface.selectHotelPreference('budget')">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Budget Friendly</span>
                        <small>Best value for money</small>
                    </button>
                    <button class="hotel-preference" data-preference="family" onclick="enhancedTravelInterface.selectHotelPreference('family')">
                        <i class="fas fa-home"></i>
                        <span>Family Friendly</span>
                        <small>Kid-friendly amenities</small>
                    </button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="interest-planning-progress">
                <div class="interest-progress-bar">
                    <div class="interest-progress-fill" id="planningProgress"></div>
                </div>
                <div class="interest-progress-text">Step <span id="currentStep">1</span> of <span id="totalSteps">5</span></div>
            </div>

            <!-- Navigation Buttons -->
            <div class="interest-planning-navigation">
                <button class="interest-planning-nav-btn secondary" id="prevStepBtn" onclick="enhancedTravelInterface.previousStep()" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="interest-planning-nav-btn primary" id="nextStepBtn" onclick="enhancedTravelInterface.nextStep()" style="display: none;">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button class="interest-planning-nav-btn primary" id="startPlanningBtn" onclick="enhancedTravelInterface.startInterestBasedPlanning()" style="display: none;">
                    <i class="fas fa-rocket"></i> Start Planning
                </button>
            </div>
        </div>

        <!-- Location Discovery Section -->
        <div class="location-discovery-section" id="locationDiscoverySection">
            <div class="location-discovery-header">
                <div class="location-discovery-title">üåç Location-Based Discovery</div>
                <div class="location-discovery-subtitle">Get personalized destination recommendations</div>
            </div>
            
            <div class="location-consent-section" id="locationConsentSection">
                <div class="location-consent-header">
                    <h3>üìç Location Access</h3>
                    <p>Get personalized destination recommendations based on your location</p>
                </div>
                
                <div class="location-consent-options">
                    <div class="location-option">
                        <div class="location-option-icon">üìç</div>
                        <div class="location-option-content">
                            <h4>Use Your Location</h4>
                            <p>Get recommendations for destinations near you and domestic travel options</p>
                            <button class="location-btn location-btn-primary" onclick="enhancedTravelInterface.requestLocationAccess()">
                                Allow Location Access
                            </button>
                        </div>
                    </div>
                    
                    <div class="location-option">
                        <div class="location-option-icon">üåê</div>
                        <div class="location-option-content">
                            <h4>Global Recommendations</h4>
                            <p>Explore worldwide destinations without sharing your location</p>
                            <button class="location-btn location-btn-secondary" onclick="enhancedTravelInterface.useDefaultLocation()">
                                Show Global Destinations
                            </button>
                        </div>
                    </div>
                </div>

                <div class="location-info" id="locationInfo" style="display: none;">
                    <h4>üìç Your Location</h4>
                    <p id="locationDetails">Detecting your location...</p>
                </div>
            </div>

            <div class="destination-filters" id="destinationFilters" style="display: none;">
                <h3>üéØ Customize Your Recommendations</h3>
                <div class="filter-group">
                    <select class="filter-select" id="tripTypeFilter" onchange="enhancedTravelInterface.applyLocationFilters()">
                        <option value="">All Trip Types</option>
                        <option value="summer">Summer Vacation</option>
                        <option value="winter">Winter Getaway</option>
                        <option value="spring">Spring Break</option>
                        <option value="fall">Fall Foliage</option>
                        <option value="honeymoon">Honeymoon</option>
                        <option value="business">Business Trip</option>
                        <option value="family">Family Vacation</option>
                        <option value="adventure">Adventure</option>
                        <option value="relaxation">Relaxation</option>
                        <option value="culture">Cultural Experience</option>
                    </select>

                    <select class="filter-select" id="interestsFilter" onchange="enhancedTravelInterface.applyLocationFilters()">
                        <option value="">All Interests</option>
                        <option value="beach">Beach</option>
                        <option value="city">City</option>
                        <option value="culture">Culture</option>
                        <option value="nature">Nature</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="history">History</option>
                        <option value="luxury">Luxury</option>
                        <option value="adventure">Adventure</option>
                    </select>
                </div>
            </div>

            <div class="destination-grid" id="destinationGrid">
                <div class="destination-loading" id="destinationLoading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Discovering amazing destinations for you...</p>
                </div>
            </div>
            
            <div class="data-source-info" id="dataSourceInfo" style="display: none;"></div>
        </div>

        </div> <!-- End of content-container -->

        <!-- Enhanced Input Area -->
        <div class="travel-input-area">
            <div class="travel-input-container">
                <input type="text" class="travel-input" id="travelInput" placeholder="Tell me about your dream trip... üåç" />
                <button class="travel-send-btn" id="travelSendBtn">‚úàÔ∏è</button>
            </div>
        </div>
    </div>

    <script>
        class EnhancedTravelInterface {
            constructor() {
                this.chatArea = document.getElementById('travelChatArea');
                this.input = document.getElementById('travelInput');
                this.sendBtn = document.getElementById('travelSendBtn');
                this.quickReplies = document.getElementById('travelQuickReplies');
                this.sessionId = this.generateSessionId();
                this.conversationState = {};
                
                // Interest-based planning properties
                this.planningData = {
                    tripType: null,
                    season: null,
                    celebration: null,
                    businessPriority: null,
                    leisureInterest: null,
                    hotelPreference: null
                };
                this.currentStep = 1;
                this.totalSteps = 5;
                
                this.initializeEventListeners();
                // Don't call showWelcomeMessage here - let handleUrlParameters handle it
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            initializeEventListeners() {
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.input.disabled) this.sendMessage();
                });
                
                // Check for URL parameters from destination discovery
                this.handleUrlParameters();
            }

            handleUrlParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const destination = urlParams.get('destination');
                const destinationType = urlParams.get('destination_type');
                const country = urlParams.get('country');
                
                if (destination) {
                    // User came from destination discovery page
                    const message = `I want to plan a trip to ${destination}`;
                    this.input.value = message;
                    
                    // Initialize conversation state with the selected destination
                    this.conversationState = {
                        current_state: "destination_selected",
                        destination: destination,
                        destination_type: destinationType,
                        country: country,
                        session_id: this.sessionId
                    };
                    
                    // Show a welcome message with the selected destination
                    const welcomeMessage = `
                        <div class="travel-message ai">
                            <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">üåç Great choice! ${destination}</div>
                            <div style="margin-bottom: 16px;">I see you've selected <strong>${destination}</strong>${destinationType ? ` (${destinationType})` : ''}${country ? ` in ${country}` : ''}. Let me help you plan the perfect trip there!</div>
                            <div style="font-weight: 600; color: #3B82F6;">Ready to start planning your ${destination} adventure? üöÄ</div>
                        </div>
                    `;
                    this.addMessage(welcomeMessage);
                    
                    // Show quick replies for next steps
                    this.showQuickReplies([
                        'Start planning this trip üöÄ',
                        'Tell me more about this destination üìç',
                        'Show me similar destinations üåç',
                        'Plan a different trip üîÑ'
                    ]);
                    
                    // Clear URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    this.showWelcomeMessage();
                }
            }

            showWelcomeMessage() {
                const welcomeMessage = `
                    <div class="travel-message ai">
                        <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">üåç Welcome to Your Travel Adventure!</div>
                        <div style="margin-bottom: 16px;">I'm your personal travel expert, ready to craft the perfect journey for you. Whether you're dreaming of exploring ancient cities, relaxing on pristine beaches, or embarking on thrilling adventures, I'm here to make it happen!</div>
                        <div style="font-weight: 600; color: #3B82F6;">Let's start planning your dream trip! üöÄ</div>
                    </div>
                `;
                this.addMessage(welcomeMessage);
                this.showQuickReplies([
                    'Plan a beach vacation üèñÔ∏è',
                    'Explore a new city üèôÔ∏è',
                    'Adventure trip üèîÔ∏è',
                    'Cultural journey üèõÔ∏è',
                    'Discover destinations near me üìç',
                    'Browse all destinations üåç',
                    'Interest-based planning üéØ'
                ]);
            }

            async sendMessage() {
                const message = this.input.value.trim();
                if (!message || this.input.disabled) return;

                // Add user message
                this.addUserMessage(message);
                this.input.value = '';
                // Hide quick replies after first user input
                this.hideQuickReplies();

                // Show loading
                this.showLoading();

                try {
                    const response = await this.processMessage(message);
                    this.hideLoading();
                    this.handleResponse(response);
                } catch (error) {
                    this.hideLoading();
                    this.showErrorMessage();
                }
            }

            addUserMessage(message) {
                const userMessage = `
                    <div class="travel-message user">
                        ${this.escapeHtml(message)}
                    </div>
                `;
                this.addMessage(userMessage);
            }

            addMessage(html) {
                this.chatArea.insertAdjacentHTML('beforeend', html);
                this.scrollToBottom();
            }

            showLoading() {
                // Disable input and send button during planning
                this.disableInput();
                
                const agenticWorkflow = `
                    <div class="agentic-workflow" id="agenticWorkflow">
                        <div class="workflow-header">
                            <div class="workflow-title">
                                ü§ñ AI Travel Agents at Work
                            </div>
                            <div class="workflow-subtitle">
                                Crafting your perfect personalized itinerary
                            </div>
                        </div>
                        
                        <div class="agents-container">
                            <div class="agent-card" id="flightAgent">
                                <div class="agent-header">
                                    <div class="agent-avatar flight">‚úàÔ∏è</div>
                                    <div class="agent-info">
                                        <h4>Flight Search Agent</h4>
                                        <p>Finding optimal routes & prices</p>
                                    </div>
                                </div>
                                <div class="agent-status">
                                    <div class="status-indicator" id="flightStatus"></div>
                                    <div class="status-text" id="flightStatusText">Initializing...</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="flightProgress"></div>
                                </div>
                                <div class="agent-details" id="flightDetails">
                                    Analyzing your route and finding the best flight options...
                                </div>
                            </div>
                            
                            <div class="agent-card" id="hotelAgent">
                                <div class="agent-header">
                                    <div class="agent-avatar hotel">üè®</div>
                                    <div class="agent-info">
                                        <h4>Hotel Search Agent</h4>
                                        <p>Locating perfect accommodations</p>
                                    </div>
                                </div>
                                <div class="agent-status">
                                    <div class="status-indicator" id="hotelStatus"></div>
                                    <div class="status-text" id="hotelStatusText">Waiting...</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="hotelProgress"></div>
                                </div>
                                <div class="agent-details" id="hotelDetails">
                                    Ready to find hotels that match your preferences...
                                </div>
                            </div>
                            
                            <div class="agent-card" id="budgetAgent">
                                <div class="agent-header">
                                    <div class="agent-avatar budget">üí∞</div>
                                    <div class="agent-info">
                                        <h4>Budget Analyst</h4>
                                        <p>Optimizing your spending</p>
                                    </div>
                                </div>
                                <div class="agent-status">
                                    <div class="status-indicator" id="budgetStatus"></div>
                                    <div class="status-text" id="budgetStatusText">Waiting...</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="budgetProgress"></div>
                                </div>
                                <div class="agent-details" id="budgetDetails">
                                    Preparing to allocate your budget across all categories...
                                </div>
                            </div>
                            
                            <div class="agent-card" id="destinationAgent">
                                <div class="agent-header">
                                    <div class="agent-avatar destination">üó∫Ô∏è</div>
                                    <div class="agent-info">
                                        <h4>Destination Specialist</h4>
                                        <p>Creating your perfect itinerary</p>
                                    </div>
                                </div>
                                <div class="agent-status">
                                    <div class="status-indicator" id="destinationStatus"></div>
                                    <div class="status-text" id="destinationStatusText">Waiting...</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="destinationProgress"></div>
                                </div>
                                <div class="agent-details" id="destinationDetails">
                                    Ready to craft your personalized travel experience...
                                </div>
                            </div>
                        </div>
                        
                        <div class="completion-message" id="completionMessage" style="display: none;">
                            <h3>üéâ Your Perfect Trip is Ready!</h3>
                            <p>All agents have completed their tasks. Your personalized itinerary is being prepared...</p>
                        </div>
                    </div>
                `;
                this.addMessage(agenticWorkflow);
                
                // Note: Animation is now started by the planning methods, not here
            }

            async startAgenticAnimationWithSuccess(planningResult) {
                // Start with normal progressive animation, then show success and display itinerary
                await this.startAgenticAnimation();
                
                // After the progressive animation completes, show success state and display itinerary
                setTimeout(async () => {
                    await this.completeAnimationWithSuccess();
                    this.displayItinerary(planningResult);
                }, 2000); // Wait 2 seconds after progressive animation completes
            }

            async startAgenticAnimationWithError() {
                // Start with normal progressive animation, then transition to error
                await this.startAgenticAnimation();
                
                // After the progressive animation completes, show error state
                setTimeout(async () => {
                    await this.completeAnimationWithError();
                    this.showErrorMessage('Our AI service is currently experiencing high demand. Please try again in a few moments.');
                }, 2000); // Wait 2 seconds after progressive animation completes
            }

            startAgenticAnimation() {
                // Wait for DOM elements to be ready before starting animation
                const checkAndStart = () => {
                    // Check if all agent cards exist
                    const flightAgent = document.getElementById('flightAgent');
                    const hotelAgent = document.getElementById('hotelAgent');
                    const budgetAgent = document.getElementById('budgetAgent');
                    const destinationAgent = document.getElementById('destinationAgent');
                    
                    if (flightAgent && hotelAgent && budgetAgent && destinationAgent) {
                        console.log('All agent cards found, starting animation');
                        // Get trip data for dynamic messaging
                        const tripData = this.getTripDataFromConversationState();
                        
                        // Dynamic agent workflow based on actual trip data
                        const agents = this.generateDynamicAgentWorkflow(tripData);

                        // Execute agent workflows with realistic timing
                        agents.forEach(agent => {
                            agent.steps.forEach((step, index) => {
                                setTimeout(() => {
                                    this.updateAgentStatus(agent.id, step);
                                }, step.delay);
                            });
                        });

                        // Show final assembly message after all agents complete
                        setTimeout(() => {
                            this.showFinalAssemblyMessage(tripData);
                        }, 2000);
                    } else {
                        console.log('Agent cards not ready yet, retrying...');
                        setTimeout(checkAndStart, 100);
                    }
                };
                
                checkAndStart();
            }

            getTripDataFromConversationState() {
                const state = this.conversationState || {};
                return {
                    origin: state.origin || 'your departure city',
                    destination: state.destination || 'your destination',
                    travelers: state.travelers || 'your group',
                    duration: state.duration_days || 'your trip duration',
                    budget: state.budget_range || state.total_budget || 'your budget',
                    interests: state.interests || [],
                    occasion: state.occasion || 'your trip purpose'
                };
            }

            generateDynamicAgentWorkflow(tripData) {
                const destination = tripData.destination;
                const travelers = tripData.travelers;
                const duration = tripData.duration;
                const budget = tripData.budget;
                const interests = tripData.interests;

                // Generate dynamic status variations
                const flightStatuses = this.generateFlightStatuses(destination, travelers, budget);
                const hotelStatuses = this.generateHotelStatuses(destination, duration, budget);
                const budgetStatuses = this.generateBudgetStatuses(budget);
                const destinationStatuses = this.generateDestinationStatuses(destination, duration, interests);

                return [
                    {
                        id: 'flightAgent',
                        name: 'Flight Search Agent',
                        steps: flightStatuses.map((status, index) => ({
                            delay: 100 + (index * 300),
                            status: index === flightStatuses.length - 1 ? 'completed' : 'working',
                            text: status.text,
                            progress: Math.min(15 + (index * 20), 100),
                            details: status.details
                        }))
                    },
                    {
                        id: 'hotelAgent',
                        name: 'Hotel Search Agent',
                        steps: hotelStatuses.map((status, index) => ({
                            delay: 200 + (index * 300),
                            status: index === hotelStatuses.length - 1 ? 'completed' : 'working',
                            text: status.text,
                            progress: Math.min(20 + (index * 20), 100),
                            details: status.details
                        }))
                    },
                    {
                        id: 'budgetAgent',
                        name: 'Budget Analyst',
                        steps: budgetStatuses.map((status, index) => ({
                            delay: 300 + (index * 300),
                            status: index === budgetStatuses.length - 1 ? 'completed' : 'working',
                            text: status.text,
                            progress: Math.min(25 + (index * 18), 100),
                            details: status.details
                        }))
                    },
                    {
                        id: 'destinationAgent',
                        name: 'Destination Specialist',
                        steps: destinationStatuses.map((status, index) => ({
                            delay: 400 + (index * 300),
                            status: index === destinationStatuses.length - 1 ? 'completed' : 'working',
                            text: status.text,
                            progress: Math.min(20 + (index * 20), 100),
                            details: status.details
                        }))
                    }
                ];
            }

            generateFlightStatuses(destination, travelers, budget) {
                const statuses = [
                    { text: 'Connecting to airlines...', details: `Establishing connection to flight databases for ${destination} routes...` },
                    { text: 'Searching routes...', details: `Finding optimal flight paths to ${destination}...` },
                    { text: 'Comparing prices...', details: `Analyzing prices for ${travelers} travelers across multiple airlines...` },
                    { text: 'Optimizing selection...', details: `Selecting best flight options based on your ${budget} budget...` },
                    { text: 'Flights found!', details: `Successfully found 9 optimal flight options for your ${destination} trip!` }
                ];
                return statuses;
            }

            generateHotelStatuses(destination, duration, budget) {
                const statuses = [
                    { text: 'Scanning accommodations...', details: `Searching hotels and accommodations in ${destination}...` },
                    { text: 'Filtering by budget...', details: `Matching properties to your ${budget} budget preferences...` },
                    { text: 'Checking availability...', details: `Verifying room availability for ${duration} days...` },
                    { text: 'Evaluating locations...', details: `Assessing proximity to attractions and transportation...` },
                    { text: 'Hotels selected!', details: `Found 9 perfect accommodations matching your preferences!` }
                ];
                return statuses;
            }

            generateBudgetStatuses(budget) {
                const statuses = [
                    { text: 'Analyzing expenses...', details: `Breaking down your ${budget} budget across all categories...` },
                    { text: 'Allocating funds...', details: `Distributing budget: 30% hotels, 25% flights, 45% activities...` },
                    { text: 'Optimizing costs...', details: `Ensuring maximum value for your ${budget} investment...` },
                    { text: 'Finalizing allocation...', details: `Fine-tuning budget distribution for optimal experience...` },
                    { text: 'Budget optimized!', details: `Perfect budget allocation ensuring best value for your money!` }
                ];
                return statuses;
            }

            generateDestinationStatuses(destination, duration, interests) {
                const interestText = interests.length > 0 ? interests.join(', ') : 'general travel';
                const statuses = [
                    { text: 'Researching attractions...', details: `Discovering must-see attractions and hidden gems in ${destination}...` },
                    { text: 'Creating schedule...', details: `Building day-by-day itinerary for your ${duration} trip...` },
                    { text: 'Adding local insights...', details: `Incorporating local tips and cultural experiences...` },
                    { text: 'Personalizing experience...', details: `Tailoring activities to your interests: ${interestText}...` },
                    { text: 'Itinerary complete!', details: `Your personalized ${destination} adventure is perfectly planned!` }
                ];
                return statuses;
            }

            showFinalAssemblyMessage(tripData) {
                const completionMessage = document.getElementById('completionMessage');
                if (completionMessage) {
                    const messages = [
                        `üéâ All systems ready! Compiling your personalized ${tripData.destination} experience... This will be amazing!`,
                        `ü§ñ All agents completed! Assembling your perfect ${tripData.duration} trip... Almost there!`,
                        `‚ú® Finalizing your ${tripData.destination} adventure... Get ready for something incredible!`,
                        `üöÄ All data collected! Creating your personalized itinerary... This is going to be epic!`
                    ];
                    
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    
                    completionMessage.innerHTML = `
                        <h3>${randomMessage}</h3>
                        <p>Your ${tripData.destination} trip for ${tripData.travelers} is being crafted with love and precision...</p>
                    `;
                    completionMessage.style.display = 'block';
                }
            }

            updateAgentStatus(agentId, step) {
                const agentCard = document.getElementById(agentId);
                const statusIndicator = document.getElementById(agentId.replace('Agent', 'Status'));
                const statusText = document.getElementById(agentId.replace('Agent', 'StatusText'));
                const progressBar = document.getElementById(agentId.replace('Agent', 'Progress'));
                const details = document.getElementById(agentId.replace('Agent', 'Details'));

                // Debug logging to help identify missing elements
                if (!agentCard) {
                    console.warn(`Agent card not found: ${agentId}`);
                    return;
                }
                if (!statusIndicator) {
                    console.warn(`Status indicator not found: ${agentId.replace('Agent', 'Status')}`);
                    return;
                }
                if (!statusText) {
                    console.warn(`Status text not found: ${agentId.replace('Agent', 'StatusText')}`);
                    return;
                }
                if (!progressBar) {
                    console.warn(`Progress bar not found: ${agentId.replace('Agent', 'Progress')}`);
                    return;
                }
                if (!details) {
                    console.warn(`Details not found: ${agentId.replace('Agent', 'Details')}`);
                    return;
                }

                // Update status indicator
                statusIndicator.className = `status-indicator ${step.status}`;
                
                // Update status text
                statusText.textContent = step.text;
                
                // Update progress bar
                progressBar.style.width = `${step.progress}%`;
                
                // Update details
                details.textContent = step.details;
                
                // Update card appearance
                if (step.status === 'working') {
                    agentCard.classList.add('active');
                } else if (step.status === 'completed') {
                    agentCard.classList.remove('active');
                    agentCard.classList.add('completed');
                }
            }

            showCompletionMessage() {
                const completionMessage = document.getElementById('completionMessage');
                if (completionMessage) {
                    completionMessage.style.display = 'block';
                }
            }

            // Complete animation with success - smoothly transition to itinerary
            async completeAnimationWithSuccess() {
                return new Promise((resolve) => {
                    // Complete all remaining agents quickly
                    const allAgents = ['flightAgent', 'hotelAgent', 'budgetAgent', 'destinationAgent'];
                    
                    allAgents.forEach((agentId, index) => {
                        setTimeout(() => {
                            const agentCard = document.getElementById(agentId);
                            const statusIndicator = document.getElementById(agentId.replace('Agent', 'Status'));
                            const statusText = document.getElementById(agentId.replace('Agent', 'StatusText'));
                            const progressBar = document.getElementById(agentId.replace('Agent', 'Progress'));
                            const details = document.getElementById(agentId.replace('Agent', 'Details'));
                            
                            if (agentCard && !agentCard.classList.contains('completed')) {
                                // Complete the agent
                                statusIndicator.className = 'status-indicator completed';
                                statusText.textContent = 'Completed!';
                                progressBar.style.width = '100%';
                                details.textContent = 'Task completed successfully!';
                                
                                agentCard.classList.remove('active');
                                agentCard.classList.add('completed');
                            }
                        }, index * 200); // Stagger completions
                    });
                    
                    // Show success completion message and resolve
                    setTimeout(() => {
                        this.showSuccessCompletionMessage();
                        setTimeout(resolve, 1500); // Give user time to see success message
                    }, allAgents.length * 200 + 500);
                });
            }

            // Complete animation with error - show error state
            async completeAnimationWithError() {
                return new Promise((resolve) => {
                    // Show error state for all agents
                    const allAgents = ['flightAgent', 'hotelAgent', 'budgetAgent', 'destinationAgent'];
                    
                    allAgents.forEach((agentId, index) => {
                        setTimeout(() => {
                            const agentCard = document.getElementById(agentId);
                            const statusIndicator = document.getElementById(agentId.replace('Agent', 'Status'));
                            const statusText = document.getElementById(agentId.replace('Agent', 'StatusText'));
                            const details = document.getElementById(agentId.replace('Agent', 'Details'));
                            
                            if (agentCard && statusIndicator && statusText && details) {
                                // Show error state
                                statusIndicator.className = 'status-indicator error';
                                statusText.textContent = 'Error occurred';
                                details.textContent = 'Unable to complete task';
                                
                                agentCard.classList.remove('active');
                                agentCard.classList.add('error');
                            } else {
                                console.warn(`Could not find elements for agent ${agentId} during error completion`);
                            }
                        }, index * 100);
                    });
                    
                    // Show error completion message and resolve
                    setTimeout(() => {
                        this.showErrorCompletionMessage();
                        setTimeout(resolve, 1000);
                    }, allAgents.length * 100 + 300);
                });
            }

            showSuccessCompletionMessage() {
                const completionMessage = document.getElementById('completionMessage');
                if (completionMessage) {
                    const tripData = this.getTripDataFromConversationState();
                    const successMessages = [
                        `üéâ Your Perfect ${tripData.destination} Trip is Ready!`,
                        `‚ú® Your Dream ${tripData.destination} Adventure Awaits!`,
                        `üöÄ Your Personalized ${tripData.destination} Experience is Complete!`,
                        `üåü Your Amazing ${tripData.destination} Journey is Ready!`
                    ];
                    
                    const randomMessage = successMessages[Math.floor(Math.random() * successMessages.length)];
                    
                    completionMessage.innerHTML = `
                        <h3>${randomMessage}</h3>
                        <p>All agents have completed their tasks successfully. Your personalized ${tripData.destination} itinerary is being prepared...</p>
                    `;
                    completionMessage.style.display = 'block';
                }
            }

            showErrorCompletionMessage() {
                const completionMessage = document.getElementById('completionMessage');
                if (completionMessage) {
                    completionMessage.innerHTML = `
                        <h3>‚ö†Ô∏è Planning Encountered Issues</h3>
                        <p>Some agents encountered problems. Let's try a different approach...</p>
                    `;
                    completionMessage.style.display = 'block';
                }
            }

            hideLoading() {
                const loadingElements = this.chatArea.querySelectorAll('.travel-loading');
                const agenticElements = this.chatArea.querySelectorAll('.agentic-workflow');
                loadingElements.forEach(el => el.remove());
                agenticElements.forEach(el => el.remove());
                
                // Re-enable input and send button after planning is complete
                this.enableInput();
            }

            disableInput() {
                this.input.disabled = true;
                this.sendBtn.disabled = true;
                this.input.placeholder = "AI agents are working on your trip...";
            }

            enableInput() {
                this.input.disabled = false;
                this.sendBtn.disabled = false;
                this.input.placeholder = "Tell me about your dream trip... üåç";
            }

            async processMessage(message) {
                console.log('Sending message:', message);
                console.log('Current conversation state:', this.conversationState);
                
                const response = await fetch('/chat-integration/process-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: this.sessionId,
                        conversation_state: this.conversationState
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to process message');
                }

                return await response.json();
            }

            handleResponse(response) {
                // Debug logging
                console.log('Frontend received response:', response);
                console.log('Current conversation state before update:', this.conversationState);
                console.log('Response message:', response.message);
                console.log('Response missing_info:', response.missing_info);
                console.log('Response conversation_state:', response.conversation_state);
                
                // Update conversation state - preserve existing state if response doesn't have one
                if (response.conversation_state) {
                    this.conversationState = response.conversation_state;
                    console.log('Updated conversation state:', this.conversationState);
                } else if (this.conversationState) {
                    // Preserve existing conversation state if response doesn't have one
                    console.log('Preserving existing conversation state:', this.conversationState);
                } else {
                    console.log('No conversation_state in response and no existing state!');
                }
                
                // Ensure missing_info is preserved in conversation state
                if (response.missing_info) {
                    if (!this.conversationState) this.conversationState = {};
                    this.conversationState.missing_info = response.missing_info;
                    console.log('Updated missing_info in conversation state:', this.conversationState.missing_info);
                }

                // Show AI message
                if (response.message) {
                    const aiMessage = `
                        <div class="travel-message ai">
                            ${this.formatMessage(response.message)}
                        </div>
                    `;
                    this.addMessage(aiMessage);
                }

                // Always hide quick replies after any AI response
                this.hideQuickReplies();

                // Handle enhancement state
                if (response.state === 'enhancement') {
                    // Show enhancement questions
                    this.askEnhancementQuestions();
                    return;
                }

                // Robust missing info/state handling
                const missing = response.missing_info || [];
                if (response.state === 'planning') {
                    // System says it has all information and is ready to plan
                    if (response.can_start_planning) {
                        // Check if we have a successful planning result
                        if (response.planning_result && response.planning_result.success) {
                            // Planning successful - show agentic animation then display itinerary
                            console.log('Planning successful, showing agentic animation then itinerary');
                            this.showLoading(); // Create the agent cards first
                            // Small delay to ensure DOM elements are ready
                            setTimeout(() => {
                                this.startAgenticAnimationWithSuccess(response.planning_result);
                            }, 100);
                        } else if (response.planning_result && !response.planning_result.success) {
                            // Planning failed - show agentic animation with error progression
                            console.log('Planning failed, showing agentic animation with error progression');
                            this.showLoading(); // Create the agent cards first
                            // Small delay to ensure DOM elements are ready
                            setTimeout(() => {
                                this.startAgenticAnimationWithError();
                            }, 100);
                        } else if (response.trip_request) {
                            // Fallback: start trip planning if no planning result
                            this.startTripPlanning(response.trip_request);
                        }
                        return;
                    } else {
                        // System says it's ready to plan but needs to start the planning process
                        console.log('System ready to plan - starting trip planning process');
                        this.startTripPlanningFromConversationState();
                        return;
                    }
                }
                // If missing required info, wait for user input (do nothing else)
                if (missing.length > 0) {
                    // The AI message already prompts for the next missing field
                    return;
                }
            }

            formatMessage(message) {
                // Convert markdown-like formatting to HTML
                return message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
            }

            showQuickReplies(replies) {
                this.quickReplies.innerHTML = replies.map(reply => 
                    `<button class="travel-quick-reply" onclick="enhancedTravelInterface.handleQuickReply('${reply}')">${reply}</button>`
                ).join('');
                this.quickReplies.style.display = 'flex';
            }

            hideQuickReplies() {
                this.quickReplies.style.display = 'none';
            }

            handleQuickReply(reply) {
                if (reply.includes('Discover destinations near me')) {
                    // Show location discovery section
                    const locationSection = document.getElementById('locationDiscoverySection');
                    locationSection.style.display = 'block';
                    console.log('Location discovery section displayed:', locationSection.style.display);
                    console.log('Location discovery section visible:', locationSection.offsetHeight > 0);
                    
                    // Debug the location options
                    const locationOptions = document.querySelectorAll('.location-option');
                    console.log('Location options found:', locationOptions.length);
                    locationOptions.forEach((option, index) => {
                        console.log(`Option ${index + 1}:`, option.offsetWidth, 'x', option.offsetHeight);
                        console.log(`Option ${index + 1} visible:`, option.offsetHeight > 0);
                    });
                    
                    this.scrollToBottom();
                } else if (reply.includes('Browse all destinations')) {
                    // Navigate to the dedicated destination discovery page in same tab
                    window.location.href = '/destination-discovery';
                } else if (reply.includes('Interest-based planning')) {
                    // Show interest-based planning section
                    this.showInterestPlanning();
                    this.scrollToBottom();
                } else if (reply.includes('Start planning this trip')) {
                    // User wants to start planning with the pre-filled destination
                    this.sendMessage();
                } else if (reply.includes('Tell me more about this destination')) {
                    // Ask for more information about the destination
                    this.input.value = 'Tell me more about this destination and what makes it special';
                    this.sendMessage();
                } else if (reply.includes('Show me similar destinations')) {
                    // Show similar destinations
                    this.input.value = 'Show me similar destinations to this one';
                    this.sendMessage();
                } else if (reply.includes('Plan a different trip')) {
                    // Reset to normal welcome flow
                    this.input.value = '';
                    this.showWelcomeMessage();
                } else {
                    this.input.value = reply;
                    this.sendMessage();
                }
            }

            async startTripPlanning(tripRequest) {
                this.showLoading();
                
                // Start the animation
                this.startAgenticAnimation();
                
                try {
                    const response = await fetch('/chat-integration/start-planning', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ trip_request: tripRequest, session_id: this.sessionId })
                    });
                    
                    if (!response.ok) {
                        // Try to parse error response
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (parseError) {
                            errorData = { detail: 'Failed to start trip planning' };
                        }
                        const error = new Error(errorData.detail || 'Failed to start trip planning');
                        error.response = { json: () => Promise.resolve(errorData) };
                        throw error;
                    }
                    const result = await response.json();
                    
                    // Complete animation with success and transition to itinerary
                    await this.completeAnimationWithSuccess();
                    this.hideLoading();
                    this.displayItinerary(result);
                } catch (error) {
                    // Complete animation with error and show error message
                    await this.completeAnimationWithError();
                    this.hideLoading();
                    
                    // Try to parse error response for better error handling
                    let errorMessage = 'Something went wrong while planning your trip. Please try again.';
                    try {
                        if (error.response) {
                            const errorData = await error.response.json();
                            if (errorData.detail && errorData.detail.includes('AI service temporarily overloaded')) {
                                errorMessage = 'Our AI service is currently experiencing high demand. Please try again in a few minutes.';
                            } else if (errorData.detail) {
                                errorMessage = errorData.detail;
                            }
                        }
                    } catch (parseError) {
                        console.log('Could not parse error response:', parseError);
                    }
                    
                    this.showErrorMessage(errorMessage);
                    console.error("Error in startTripPlanning:", error);
                }
            }

            async startTripPlanningFromConversationState() {
                this.showLoading();
                
                // Start the animation
                this.startAgenticAnimation();
                
                try {
                    // Create a trip request from the current conversation state
                    const tripRequest = {
                        origin: this.conversationState.origin,
                        destination: this.conversationState.destination,
                        travelers: this.conversationState.travelers,
                        start_date: this.conversationState.start_date,
                        duration_days: this.conversationState.duration_days,
                        budget_range: this.conversationState.budget_range,
                        trip_type: 'leisure',
                        interests: this.conversationState.interests || [],
                        special_requirements: '',
                        total_budget: this.conversationState.total_budget
                    };
                    
                    console.log('Starting trip planning with request:', tripRequest);
                    
                    const response = await fetch('/chat-integration/start-planning', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ trip_request: tripRequest, session_id: this.sessionId })
                    });
                    
                    if (!response.ok) {
                        // Try to parse error response
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch (parseError) {
                            errorData = { detail: 'Failed to start trip planning' };
                        }
                        const error = new Error(errorData.detail || 'Failed to start trip planning');
                        error.response = { json: () => Promise.resolve(errorData) };
                        throw error;
                    }
                    const result = await response.json();
                    
                    // Complete animation with success and transition to itinerary
                    await this.completeAnimationWithSuccess();
                    this.hideLoading();
                    this.displayItinerary(result);
                } catch (error) {
                    // Complete animation with error and show error message
                    await this.completeAnimationWithError();
                    this.hideLoading();
                    
                    // Try to parse error response for better error handling
                    let errorMessage = 'Something went wrong while planning your trip. Please try again.';
                    try {
                        if (error.response) {
                            const errorData = await error.response.json();
                            if (errorData.detail && errorData.detail.includes('AI service temporarily overloaded')) {
                                errorMessage = 'Our AI service is currently experiencing high demand. Please try again in a few minutes.';
                            } else if (errorData.detail) {
                                errorMessage = errorData.detail;
                            }
                        }
                    } catch (parseError) {
                        console.log('Could not parse error response:', parseError);
                    }
                    
                    this.showErrorMessage(errorMessage);
                    console.error("Error in startTripPlanningFromConversationState:", error);
                }
            }

            displayItinerary(result) {
                try {
                    // Remove any previous itinerary from the chat area
                    const oldItineraries = this.chatArea.querySelectorAll('.travel-itinerary');
                    oldItineraries.forEach(el => el.remove());

                    if (result.success && result.itinerary) {
                        const itineraryHtml = this.createItineraryHTML(result.itinerary);
                        this.addMessage(itineraryHtml);
                        this.scrollToBottom();
                        // Attach tab switching using event delegation
                        this.attachTabDelegation();
                        
                        // Initialize the travel map
                        this.initializeTravelMap();
                    } else {
                        this.showErrorMessage();
                    }
                } catch (e) {
                    console.error('Error rendering itinerary:', e);
                }
            }

            attachTabDelegation() {
                const itineraryElem = this.chatArea.querySelector('.travel-itinerary');
                if (!itineraryElem) return;
                const tabsContainer = itineraryElem.querySelector('.travel-itinerary-tabs');
                if (!tabsContainer) return;
                tabsContainer.onclick = (event) => {
                    const btn = event.target.closest('.travel-tab-btn');
                    if (!btn) return;
                    // Hide all tabs
                    itineraryElem.querySelectorAll('.travel-tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    itineraryElem.querySelectorAll('.travel-tab-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    // Show selected tab
                    const tabName = btn.getAttribute('data-tab');
                    const tabContent = itineraryElem.querySelector(`#${tabName}-tab`);
                    if (tabContent) tabContent.classList.add('active');
                    btn.classList.add('active');
                };
            }

            createItineraryHTML(itinerary) {
                return `
                    <div class="travel-itinerary">
                        <div class="travel-itinerary-header">
                            <div class="travel-itinerary-title">${itinerary.trip_summary?.title || 'Your Perfect Trip'}</div>
                            <div class="travel-itinerary-subtitle">Crafted with love by your travel expert</div>
                        </div>
                        <div class="travel-route-animation">
                            <div class="world-map-container">
                                <div id="travelMap" class="travel-map"></div>
                                <div class="route-info">
                                    <div class="route-text">Your journey from <span class="origin-city">${this.conversationState?.origin || 'Origin'}</span> to <span class="destination-city">${this.conversationState?.destination || 'Destination'}</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="travel-itinerary-tabs">
                            <button class="travel-tab-btn active" data-tab="summary">üìã Summary</button>
                            <button class="travel-tab-btn" data-tab="itinerary">üóìÔ∏è Itinerary</button>
                            <button class="travel-tab-btn" data-tab="flights">‚úàÔ∏è Flights</button>
                            <button class="travel-tab-btn" data-tab="hotels">üè® Hotels</button>
                            <button class="travel-tab-btn" data-tab="practical">‚ÑπÔ∏è Practical Info</button>
                        </div>
                        <div class="travel-tab-content active" id="summary-tab">
                            ${this.createSummaryTab(itinerary)}
                        </div>
                        <div class="travel-tab-content" id="itinerary-tab">
                            ${this.createItineraryTab(itinerary)}
                        </div>
                        <div class="travel-tab-content" id="flights-tab">
                            ${this.createFlightsTab(itinerary)}
                        </div>
                        <div class="travel-tab-content" id="hotels-tab">
                            ${this.createHotelsTab(itinerary)}
                        </div>
                        <div class="travel-tab-content" id="practical-tab">
                            ${this.createPracticalTab(itinerary)}
                        </div>
                    </div>
                `;
            }

            async initializeTravelMap() {
                try {
                    // Wait for the map container to be available
                    const mapContainer = document.getElementById('travelMap');
                    if (!mapContainer) {
                        console.warn('Map container not found');
                        return;
                    }

                    // Get origin and destination from conversation state
                    const origin = this.conversationState?.origin || 'Dallas';
                    const destination = this.conversationState?.destination || 'Las Vegas';

                    // Get coordinates for origin and destination
                    const originCoords = await this.getCoordinates(origin);
                    const destinationCoords = await this.getCoordinates(destination);

                    if (!originCoords || !destinationCoords) {
                        console.warn('Could not get coordinates for map');
                        return;
                    }

                    // Initialize the map
                    const map = L.map('travelMap').setView([0, 0], 2);

                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(map);

                    // Create custom markers
                    const originIcon = L.divIcon({
                        className: 'origin-marker',
                        html: '',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    const destinationIcon = L.divIcon({
                        className: 'destination-marker',
                        html: '',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });

                    // Add markers
                    const originMarker = L.marker([originCoords.lat, originCoords.lng], { icon: originIcon })
                        .addTo(map)
                        .bindPopup(`<strong>Origin:</strong> ${origin}`);

                    const destinationMarker = L.marker([destinationCoords.lat, destinationCoords.lng], { icon: destinationIcon })
                        .addTo(map)
                        .bindPopup(`<strong>Destination:</strong> ${destination}`);

                    // Create flight path (great circle route)
                    const flightPath = this.createFlightPath(originCoords, destinationCoords);
                    const polyline = L.polyline(flightPath, {
                        color: '#F59E0B',
                        weight: 3,
                        opacity: 0.8,
                        dashArray: '10, 5'
                    }).addTo(map);

                    // Add animated airplane along the path
                    this.animateAirplaneAlongPath(map, flightPath, originCoords, destinationCoords);

                    // Fit map to show both markers
                    const group = new L.featureGroup([originMarker, destinationMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));

                } catch (error) {
                    console.error('Error initializing travel map:', error);
                }
            }

            async getCoordinates(city) {
                try {
                    // Use Nominatim (free geocoding service)
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        return {
                            lat: parseFloat(data[0].lat),
                            lng: parseFloat(data[0].lon)
                        };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting coordinates:', error);
                    return null;
                }
            }

            createFlightPath(origin, destination) {
                // Create a great circle path between two points
                const path = [];
                const steps = 50;
                
                for (let i = 0; i <= steps; i++) {
                    const t = i / steps;
                    const lat = origin.lat + (destination.lat - origin.lat) * t;
                    const lng = origin.lng + (destination.lng - origin.lng) * t;
                    path.push([lat, lng]);
                }
                
                return path;
            }

            animateAirplaneAlongPath(map, path, origin, destination) {
                let currentStep = 0;
                const totalSteps = path.length;
                
                // Create airplane marker
                const airplaneIcon = L.divIcon({
                    className: 'airplane-marker',
                    html: '‚úàÔ∏è',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const airplane = L.marker([origin.lat, origin.lng], { icon: airplaneIcon }).addTo(map);

                // Animate airplane along the path
                const animate = () => {
                    if (currentStep < totalSteps) {
                        const [lat, lng] = path[currentStep];
                        airplane.setLatLng([lat, lng]);
                        currentStep++;
                        setTimeout(animate, 100); // Adjust speed as needed
                    } else {
                        // Reset animation after a delay
                        setTimeout(() => {
                            currentStep = 0;
                            airplane.setLatLng([origin.lat, origin.lng]);
                            setTimeout(animate, 2000); // Wait 2 seconds before restarting
                        }, 2000);
                    }
                };

                // Start animation after a short delay
                setTimeout(animate, 1000);
            }

            createSummaryTab(itinerary) {
                const summary = itinerary.trip_summary;
                return `
                    <div style="padding: 24px;">
                        <div style="font-size: 20px; font-weight: 700; margin-bottom: 16px; color: #1F2937;">${summary?.title || 'Trip Overview'}</div>
                        <div style="color: #4B5563; line-height: 1.6; margin-bottom: 20px;">${summary?.overview || 'Your amazing journey awaits!'}</div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div style="background: #F0F9FF; padding: 16px; border-radius: 12px; border-left: 4px solid #3B82F6;">
                                <div style="font-weight: 700; color: #1E3A8A;">Start Date</div>
                                <div style="color: #64748B;">${summary?.start_date || 'TBD'}</div>
                            </div>
                            <div style="background: #F0FDF4; padding: 16px; border-radius: 12px; border-left: 4px solid #10B981;">
                                <div style="font-weight: 700; color: #047857;">End Date</div>
                                <div style="color: #64748B;">${summary?.end_date || 'TBD'}</div>
                            </div>
                            <div style="background: #FEF3C7; padding: 16px; border-radius: 12px; border-left: 4px solid #F59E0B;">
                                <div style="font-weight: 700; color: #92400E;">Theme</div>
                                <div style="color: #64748B;">${summary?.travel_theme || 'Adventure'}</div>
                            </div>
                        </div>
                        
                        <div style="background: #F8FAFC; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-weight: 700; color: #1F2937; margin-bottom: 8px;">Highlights</div>
                            <ul style="color: #4B5563; padding-left: 20px;">
                                ${(summary?.highlights || []).map(highlight => `<li>${highlight}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="background: #FEF3C7; padding: 16px; border-radius: 12px;">
                            <div style="font-weight: 700; color: #92400E; margin-bottom: 8px;">üå§Ô∏è Weather Forecast</div>
                            ${summary?.weather_summary ? `
                                <div style="color: #4B5563; margin-bottom: 8px;">
                                    <strong>Average Temperature:</strong> ${summary.weather_summary.avg_temp_f}¬∞F (${summary.weather_summary.avg_temp_c}¬∞C)
                                </div>
                                <div style="color: #4B5563; margin-bottom: 8px;">
                                    <strong>Conditions:</strong> ${summary.weather_summary.conditions}
                                </div>
                                <div style="color: #4B5563;">
                                    <strong>Packing Tip:</strong> ${summary.weather_summary.packing_tip}
                                </div>
                            ` : '<div style="color: #4B5563;">Check local weather before your trip</div>'}
                        </div>
                    </div>
                `;
            }

            createItineraryTab(itinerary) {
                const detailed = itinerary.detailed_itinerary || itinerary.itinerary || {};
                if (!detailed || Object.keys(detailed).length === 0) return '<div style="padding: 24px; color: #64748B;">Itinerary coming soon...</div>';
                let html = '<div style="padding: 24px;">';
                let dayNum = 1;
                for (const [key, day] of Object.entries(detailed)) {
                    if (!key.startsWith('day_')) continue;
                    html += `<div class="travel-day-card">
                        <div class="travel-day-header">
                            <div class="travel-day-icon">${dayNum}</div>
                            <div style="flex: 1;">
                                <div class="travel-day-title">Day ${dayNum}${day.theme ? ' ‚Äì ' + day.theme.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''}${day.date ? ' (' + day.date + ')' : ''}</div>
                                ${day.cultural_context ? `<div class="travel-day-theme">${day.cultural_context}</div>` : ''}
                            </div>
                            ${day.weather ? `
                                <div style="background: #F0F9FF; padding: 8px 12px; border-radius: 8px; text-align: center; min-width: 80px;">
                                    <div style="font-size: 12px; color: #1E40AF; font-weight: 600;">${day.weather.condition}</div>
                                    <div style="font-size: 14px; color: #1E40AF; font-weight: 700;">${day.weather.temperature_f}¬∞F</div>
                                    <div style="font-size: 10px; color: #64748B;">${day.weather.temperature_c}¬∞C</div>
                                </div>
                            ` : ''}
                        </div>`;
                    // Time blocks
                    const blocks = [
                        {k: 'morning', icon: '‚òÄÔ∏è', label: 'Morning'},
                        {k: 'lunch', icon: 'üçΩÔ∏è', label: 'Lunch'},
                        {k: 'afternoon', icon: 'üïë', label: 'Afternoon'},
                        {k: 'dinner', icon: 'üç≤', label: 'Dinner'},
                        {k: 'evening', icon: 'üåô', label: 'Evening'}
                    ];
                    for (const {k, icon, label} of blocks) {
                        const block = day[k];
                        if (!block) continue;
                        html += `<div class="travel-activity">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">${icon}</span>
                                <span class="travel-activity-title">${block.activity || block.restaurant || label}</span>
                                ${block.duration ? `<span style="margin-left: 10px; color: #64748B; font-size: 13px;">‚è±Ô∏è ${block.duration}</span>` : ''}
                                ${block.cost ? `<span style="margin-left: 10px; color: #059669; font-size: 13px;">üí≤${block.cost}</span>` : ''}
                            </div>
                            ${block.location ? `<div class="travel-activity-location" style="color: #64748B; font-size: 13px; margin-top: 2px;">üìç ${block.location}</div>` : ''}
                            ${block.description ? `<div class="travel-activity-description">${block.description}</div>` : ''}
                            ${block.booking_link ? `<a href="${block.booking_link}" target="_blank" class="travel-book-btn" style="margin-top: 8px;">Book/Reserve</a>` : ''}
                            ${block.tips && block.tips.length ? `<div class="travel-activity-tips">${block.tips.map(t => `‚Ä¢ ${t}`).join('<br>')}</div>` : ''}
                            ${block.local_tips && block.local_tips.length ? `<div class="travel-activity-tips">${block.local_tips.map(t => `‚Ä¢ ${t}`).join('<br>')}</div>` : ''}
                            ${block.accessibility ? `<div class="travel-activity-tips">‚ôø Accessibility: ${block.accessibility}</div>` : ''}
                        </div>`;
                    }
                    // Local insights/cultural context at end of day
                    if (day.local_insights) {
                        html += `<div class="travel-activity-tips" style="background: #DBEAFE; color: #1E3A8A; margin-top: 12px;">üåç Local Insights: ${day.local_insights}</div>`;
                    }
                    html += '</div>';
                    dayNum++;
                }
                html += '</div>';
                return html;
            }

            createDayActivities(day) {
                let html = '';
                const timeSlots = ['morning', 'lunch', 'afternoon', 'dinner', 'evening'];
                
                timeSlots.forEach(slot => {
                    if (day[slot]) {
                        const activity = day[slot];
                        html += `
                            <div class="travel-activity">
                                <div class="travel-activity-time">${slot.toUpperCase()}</div>
                                <div class="travel-activity-title">${activity.activity || activity.restaurant || 'Activity'}</div>
                                <div class="travel-activity-description">${activity.description || ''}</div>
                                ${activity.tips ? `<div class="travel-activity-tips">üí° ${activity.tips.join(', ')}</div>` : ''}
                            </div>
                        `;
                    }
                });
                
                return html;
            }

            createFlightsTab(itinerary) {
                const transportation = itinerary.transportation;
                if (!transportation) return '<div style="padding: 24px; color: #64748B;">Flight information coming soon...</div>';

                let html = '<div style="padding: 24px;">';
                
                ['fastest', 'cheapest', 'optimal'].forEach(category => {
                    if (transportation[category] && transportation[category].length > 0) {
                        html += `<div style="margin-bottom: 24px;">`;
                        html += `<div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #1F2937;">${this.getCategoryIcon(category)} ${category.toUpperCase()} Flights</div>`;
                        
                        transportation[category].forEach((flight, index) => {
                            html += `
                                <div class="travel-option-card">
                                    <div class="travel-option-header">
                                        <div class="travel-option-name">${flight.airline} ${flight.flight_number || ''}</div>
                                        <div class="travel-option-price">$${flight.cost}</div>
                                    </div>
                                    <div class="travel-option-details">
                                        <div>üõ´ ${flight.departure_time}</div>
                                        <div>üõ¨ ${flight.arrival_time}</div>
                                        <div>‚è±Ô∏è ${flight.duration}</div>
                                        <div>‚úàÔ∏è ${flight.stops || 0} stops</div>
                                    </div>
                                    ${flight.booking_link ? `<a href="${flight.booking_link}" target="_blank" class="travel-book-btn">Book Flight</a>` : ''}
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                });
                
                html += '</div>';
                return html;
            }

            createHotelsTab(itinerary) {
                const accommodation = itinerary.accommodation;
                if (!accommodation) return '<div style="padding: 24px; color: #64748B;">Hotel information coming soon...</div>';

                let html = '<div style="padding: 24px;">';
                
                ['budget', 'moderate', 'luxury'].forEach(category => {
                    if (accommodation[category] && accommodation[category].length > 0) {
                        html += `<div style="margin-bottom: 24px;">`;
                        html += `<div style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #1F2937;">${this.getCategoryIcon(category)} ${category.toUpperCase()} Hotels</div>`;
                        
                        accommodation[category].forEach((hotel, index) => {
                            html += `
                                <div class="travel-option-card">
                                    <div class="travel-option-header">
                                        <div class="travel-option-name">${hotel.name}</div>
                                        <div class="travel-option-price">$${hotel.price_per_night}/night</div>
                                    </div>
                                    <div class="travel-option-details">
                                        <div>üìç ${hotel.location}</div>
                                        <div>üè® ${hotel.type || 'Hotel'}</div>
                                    </div>
                                    ${hotel.booking_link ? `<a href="${hotel.booking_link}" target="_blank" class="travel-book-btn">Book Hotel</a>` : ''}
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                });
                
                html += '</div>';
                return html;
            }

            createPracticalTab(itinerary) {
                const practical = itinerary.practical_info;
                const cultural = itinerary.cultural_insights;
                
                return `
                    <div style="padding: 24px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="background: #F0F9FF; padding: 16px; border-radius: 12px;">
                                <div style="font-weight: 700; color: #1E3A8A; margin-bottom: 12px;">üí∞ Currency & Language</div>
                                <div style="color: #4B5563; margin-bottom: 8px;"><strong>Currency:</strong> ${practical?.currency || 'Local currency'}</div>
                                <div style="color: #4B5563;"><strong>Language:</strong> ${practical?.language || 'Local language'}</div>
                            </div>
                            
                            <div style="background: #F0FDF4; padding: 16px; border-radius: 12px;">
                                <div style="font-weight: 700; color: #047857; margin-bottom: 12px;">üåç Cultural Tips</div>
                                <ul style="color: #4B5563; padding-left: 20px; font-size: 14px;">
                                    ${(cultural?.local_customs || []).slice(0, 3).map(tip => `<li>${tip}</li>`).join('') || '<li>Cultural information coming soon...</li>'}
                                </ul>
                            </div>
                            
                            <div style="background: #FEF3C7; padding: 16px; border-radius: 12px;">
                                <div style="font-weight: 700; color: #92400E; margin-bottom: 12px;">üéí Packing Tips</div>
                                <ul style="color: #4B5563; padding-left: 20px; font-size: 14px;">
                                    ${(practical?.packing_suggestions || []).slice(0, 3).map(item => `<li>${item}</li>`).join('') || '<li>Packing information coming soon...</li>'}
                                </ul>
                            </div>
                            
                            <div style="background: #FEF2F2; padding: 16px; border-radius: 12px;">
                                <div style="font-weight: 700; color: #DC2626; margin-bottom: 12px;">üö® Emergency</div>
                                <div style="color: #4B5563; font-size: 14px;">
                                    ${(practical?.emergency_numbers || []).join(', ') || 'Emergency information coming soon...'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            showTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.travel-tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.travel-tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(`${tabName}-tab`).classList.add('active');
                event.target.classList.add('active');
            }

            getDayIcon(dayKey) {
                const icons = {
                    'day_1': 'üåÖ',
                    'day_2': 'üåû',
                    'day_3': 'üåÜ',
                    'day_4': 'üåô',
                    'day_5': '‚≠ê'
                };
                return icons[dayKey] || 'üóìÔ∏è';
            }

            getCategoryIcon(category) {
                const icons = {
                    'fastest': '‚ö°',
                    'cheapest': 'üí∞',
                    'optimal': '‚≠ê',
                    'budget': 'üí∞',
                    'moderate': 'üè®',
                    'luxury': 'üëë'
                };
                return icons[category] || 'üìã';
            }

            showErrorMessage() {
                const errorMessage = `
                    <div class="travel-message ai">
                        <div style="color: #DC2626; font-weight: 600;">Oops! Something went wrong.</div>
                        <div style="margin-top: 8px;">Don't worry, let's try again! You can ask me anything about your travel plans.</div>
                    </div>
                `;
                this.addMessage(errorMessage);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            scrollToBottom() {
                this.chatArea.scrollTop = this.chatArea.scrollHeight;
            }

            // Location Discovery Methods
            async requestLocationAccess() {
                try {
                    const position = await this.getCurrentPosition();
                    this.userLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    
                    this.showLocationInfo(`üìç Location detected: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`);
                    await this.loadLocationDiscoveryData(true, this.userLocation);
                    
                } catch (error) {
                    console.error('Location access denied or failed:', error);
                    this.showLocationInfo('‚ùå Location access denied. Using IP-based detection.');
                    await this.loadLocationDiscoveryData(true);
                }
            }

            useDefaultLocation() {
                this.showLocationInfo('üåê Using global recommendations (no location access)');
                this.loadLocationDiscoveryData(false, null, true); // Pass true for global
            }

            getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }

                    const timeout = setTimeout(() => {
                        reject(new Error('Location request timed out'));
                    }, 10000);

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            clearTimeout(timeout);
                            resolve(position);
                        },
                        (error) => {
                            clearTimeout(timeout);
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                });
            }

            showLocationInfo(message) {
                const locationInfo = document.getElementById('locationInfo');
                const locationDetails = document.getElementById('locationDetails');
                
                locationDetails.textContent = message;
                locationInfo.classList.add('show');
            }

            async loadLocationDiscoveryData(userConsent = false, gpsCoordinates = null, useGlobal = false) {
                try {
                    // Show discovery content (filters will be shown only if user requests them)
                    document.getElementById('locationDiscoverySection').style.display = 'block';

                    // Build API URL with parameters
                    const params = new URLSearchParams({
                        user_consent: userConsent
                    });

                    if (useGlobal) {
                        params.append('use_global', 'true');
                    } else if (gpsCoordinates) {
                        params.append('lat', gpsCoordinates.lat);
                        params.append('lon', gpsCoordinates.lon);
                    }

                    const response = await fetch(`/api/location-discovery/discovery-homepage?${params}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayLocationDiscoveryData(data);
                    } else {
                        throw new Error(data.message || 'Failed to load discovery data');
                    }

                } catch (error) {
                    console.error('Error loading discovery data:', error);
                    this.showLocationError('Failed to load discovery data. Please try again.');
                }
            }

            displayLocationDiscoveryData(data) {
                // Display location info
                const location = data.user_location;
                this.showLocationInfo(`üìç ${location.country} (${location.city}) - Detected via ${location.detection_method}`);

                // Display destinations
                this.displayDestinations(data.domestic_suggestions, data.international_suggestions);

                // Show data source
                this.showDataSource(data.data_source);
            }

            displayDestinations(domesticSuggestions, internationalSuggestions) {
                const grid = document.getElementById('destinationGrid');
                grid.innerHTML = '';

                // Combine and display all suggestions
                const allDestinations = [
                    ...(domesticSuggestions || []),
                    ...(internationalSuggestions || [])
                ];

                if (allDestinations.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">No recommendations available at the moment.</p>';
                    return;
                }

                allDestinations.forEach(destination => {
                    const card = this.createDestinationCard(destination);
                    grid.appendChild(card);
                });
            }

            createDestinationCard(destination) {
                const card = document.createElement('div');
                card.className = 'destination-card';
                
                const highlights = destination.highlights || [];
                const highlightsHtml = highlights.length > 0 
                    ? `<ul>${highlights.map(h => `<li>‚Ä¢ ${h}</li>`).join('')}</ul>`
                    : '<p>Discover amazing experiences</p>';

                card.innerHTML = `
                    <h3>${destination.name}</h3>
                    <div class="type">${destination.type || 'Destination'}</div>
                    ${destination.country ? `<div class="country">${destination.country}</div>` : ''}
                    <div class="highlights">
                        ${highlightsHtml}
                    </div>
                `;

                // Add click handler to start trip planning
                card.addEventListener('click', () => {
                    this.startTripPlanningFromDestination(destination);
                });

                return card;
            }

            startTripPlanningFromDestination(destination) {
                const location = this.userLocation ? `${this.userLocation.lat},${this.userLocation.lon}` : 'Unknown';
                
                // Add a message about the selected destination
                const message = `I want to plan a trip to ${destination.name}`;
                this.input.value = message;
                this.sendMessage();
                
                // Hide location discovery section
                document.getElementById('locationDiscoverySection').style.display = 'none';
            }

            showDataSource(dataSource) {
                const dataSourceInfo = document.getElementById('dataSourceInfo');
                dataSourceInfo.textContent = `Data Source: ${dataSource === 'dynamic_api' ? 'Real-time API' : 'Fallback Database'}`;
                dataSourceInfo.style.display = 'block';
            }

            applyLocationFilters() {
                const tripType = document.getElementById('tripTypeFilter').value;
                const interests = document.getElementById('interestsFilter').value;
                
                // Reload data with new filters
                if (this.userLocation) {
                    this.loadLocationDiscoveryData(true, this.userLocation);
                } else {
                    this.loadLocationDiscoveryData(false);
                }
            }

            showLocationError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'travel-message ai';
                errorDiv.innerHTML = `<div style="color: #DC2626; font-weight: 600;">${message}</div>`;
                
                this.chatArea.appendChild(errorDiv);
                this.scrollToBottom();
            }

            // Conversational Interest Planning Methods - Integrated with chat_integration_router.py
            showInterestPlanning() {
                // Show the conversational interface instead of step-based
                document.getElementById('conversationalInterests').style.display = 'block';
                document.getElementById('locationDiscoverySection').style.display = 'none';
                
                // Start the conversational flow that syncs with the backend
                this.startConversationalFlow();
            }

            startConversationalFlow() {
                // Initialize conversation state to match chat_integration_router.py
                this.conversationState = {
                    current_state: 'greeting',
                    trip_data: {},
                    session_id: this.generateSessionId()
                };
                
                // Show the first conversational question using the conversation service pattern
                this.askFirstQuestion();
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }



            askFirstQuestion() {
                // This follows the conversation_service.py pattern
                const message = `üéØ Perfect! Let's plan your dream adventure together! I'll ask you a few key questions to understand your preferences, and then we'll create an amazing itinerary with real flights and hotels!`;
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div style="margin-top: 12px;">
                            <button class="travel-quick-reply" onclick="enhancedTravelInterface.askOriginQuestion()">
                                üöÄ Start Planning
                            </button>
                        </div>
                    </div>
                `);
            }

            // Conversational questions that follow the 4-key-question structure from conversation_service.py
            askOriginQuestion() {
                const message = `üöÄ **Where are you starting from?** What city or airport should I use as your departure point?`;
                const quickReplies = ['New York', 'Los Angeles', 'Chicago', 'Miami', 'Other city'];
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="enhancedTravelInterface.handleOriginResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleOriginResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                if (!this.conversationState.trip_data) this.conversationState.trip_data = {};
                this.conversationState.trip_data.origin = response;
                
                // Ask the next question
                this.askDestinationQuestion();
            }

            askDestinationQuestion() {
                const message = `üåç **Where's calling your name?** Got a destination in mind or shall I reveal some hidden gems?`;
                const quickReplies = ['Beach paradise', 'Urban exploration', 'Mountain adventure', 'Cultural journey', 'Tell me more'];
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="enhancedTravelInterface.handleDestinationResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleDestinationResponse(response) {
                // Add user's response to chat
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state (following chat_integration_router.py pattern)
                if (!this.conversationState.trip_data) this.conversationState.trip_data = {};
                this.conversationState.trip_data.destination = response;
                
                // Ask the next question in the sequence
                this.askTravelersQuestion();
            }

            askTravelersQuestion() {
                const message = `üë• **Who's joining your adventure?** Solo explorer, romantic duo, family expedition, or friend squad?`;
                const quickReplies = ['Solo explorer', 'Romantic duo', 'Family expedition', 'Friend squad', 'Other'];
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="enhancedTravelInterface.handleTravelersResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleTravelersResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.trip_data.travelers = response;
                
                // Ask the next question
                this.askDatesQuestion();
            }

            askDatesQuestion() {
                const message = `üìÖ **When's your adventure time?** Dates and how long you want to immerse yourself?`;
                const quickReplies = ['Next month', 'Summer', 'Winter', 'Spring', 'Flexible dates'];
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="enhancedTravelInterface.handleDatesResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleDatesResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.trip_data.dates = response;
                
                // Ask the final question
                this.askVibeQuestion();
            }

            askVibeQuestion() {
                const message = `üéØ **What's your adventure style?** Relaxation, thrill-seeking, cultural immersion, or pure exploration?`;
                const quickReplies = ['Relaxation', 'Thrill-seeking', 'Cultural immersion', 'Perfect blend', 'Surprise me'];
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="travelInterface.handleVibeResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleVibeResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.trip_data.vibe = response;
                
                // Show trip summary and start planning
                this.showTripSummary();
            }

            showTripSummary() {
                const tripData = this.conversationState.trip_data;
                const summary = `üéâ **Perfect! Here's your adventure summary:**

‚Ä¢ **Destination**: ${tripData.destination || 'Your chosen destination'}
‚Ä¢ **Travelers**: ${tripData.travelers || 'Your travel companions'}
‚Ä¢ **When**: ${tripData.dates || 'Your selected dates'}
‚Ä¢ **Style**: ${tripData.vibe || 'Your adventure style'}

Now let me craft your complete itinerary with real flights and hotels! üöÄ`;
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${summary}</div>
                        <div style="margin-top: 16px;">
                            <button class="travel-quick-reply primary" onclick="travelInterface.startTripPlanning()">
                                üéØ Start Planning My Trip
                            </button>
                        </div>
                    </div>
                `);
            }

            startTripPlanning() {
                // Hide the conversational interface
                document.getElementById('conversationalInterests').style.display = 'none';
                
                // Create a natural language message that the chat_integration_router.py can process
                const tripData = this.conversationState.trip_data;
                const message = `I want to plan a trip to ${tripData.destination} for ${tripData.travelers} starting ${tripData.dates} with a ${tripData.vibe} style.`;
                
                // Set the message in the input and send it
                this.input.value = message;
                this.sendMessage();
                
                // Don't clear conversation state - preserve it for potential retries
                // this.conversationState = null;
            }

            handleDatesResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.trip_data.dates = response;
                
                // Ask the final question
                this.askVibeQuestion();
            }

            askVibeQuestion() {
                const message = `üéØ **What's your adventure style?** Relaxation, thrill-seeking, cultural immersion, or pure exploration?`;
                const quickReplies = ['Relaxation', 'Thrill-seeking', 'Cultural immersion', 'Perfect blend', 'Surprise me'];
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="travelInterface.handleVibeResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleVibeResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.trip_data.vibe = response;
                
                // Show trip summary and start planning
                this.showTripSummary();
            }

            showTripSummary() {
                const tripData = this.conversationState.trip_data;
                const summary = `üéâ **Perfect! Here's your adventure summary:**

‚Ä¢ **Destination**: ${tripData.destination || 'Your chosen destination'}
‚Ä¢ **Travelers**: ${tripData.travelers || 'Your travel companions'}
‚Ä¢ **When**: ${tripData.dates || 'Your selected dates'}
‚Ä¢ **Style**: ${tripData.vibe || 'Your adventure style'}

Now let me craft your complete itinerary with real flights and hotels! üöÄ`;
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${summary}</div>
                        <div style="margin-top: 16px;">
                            <button class="travel-quick-reply primary" onclick="travelInterface.startTripPlanning()">
                                üéØ Start Planning My Trip
                            </button>
                        </div>
                    </div>
                `);
            }

            startTripPlanning() {
                // Hide the conversational interface
                document.getElementById('conversationalInterests').style.display = 'none';
                
                // Create a natural language message that the chat_integration_router.py can process
                const tripData = this.conversationState.trip_data;
                const message = `I want to plan a trip to ${tripData.destination} for ${tripData.travelers} starting ${tripData.dates} with a ${tripData.vibe} style.`;
                
                // Set the message in the input and send it
                this.input.value = message;
                this.sendMessage();
                
                // Don't clear conversation state - preserve it for potential retries
                // this.conversationState = null;
            }

            // Quick action methods for conversational flow
            askTripType() {
                this.askDestinationQuestion();
            }

            askOccasion() {
                this.askTravelersQuestion();
            }

            askInterests() {
                this.askVibeQuestion();
            }

            askAccommodation() {
                // This will be handled naturally in the conversation flow
                const message = `üè® Great question! I'll ask about your accommodation preferences as we plan your trip. For now, let's focus on the main details first.`;
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div style="margin-top: 12px;">
                            <button class="travel-quick-reply" onclick="enhancedTravelInterface.askDestinationQuestion()">
                                üöÄ Continue Planning
                            </button>
                        </div>
                    </div>
                `);
            }

            selectTripType(type) {
                this.planningData.tripType = type;
                this.updateSelection('interest-option', type);
                this.showNextStep();
            }

            selectSeason(season) {
                this.planningData.season = season;
                this.updateSelection('season-option', season);
                this.showNextStep();
            }

            selectCelebration(celebration) {
                this.planningData.celebration = celebration;
                this.updateSelection('celebration-option', celebration);
                this.showNextStep();
            }

            selectBusinessPriority(priority) {
                this.planningData.businessPriority = priority;
                this.updateSelection('business-option', priority);
                this.showNextStep();
            }

            selectLeisureInterest(interest) {
                this.planningData.leisureInterest = interest;
                this.updateSelection('leisure-option', interest);
                this.showNextStep();
            }

            selectHotelPreference(preference) {
                this.planningData.hotelPreference = preference;
                this.updateSelection('hotel-preference', preference);
                this.showNextStep();
            }

            updateSelection(className, value) {
                // Remove previous selections
                document.querySelectorAll(`.${className}`).forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Select current option
                const selectedOption = document.querySelector(`[data-${className.split('-')[0]}="${value}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            }

            showNextStep() {
                const currentStepElement = document.querySelector(`#${this.getCurrentStepId()}`);
                if (currentStepElement) {
                    currentStepElement.style.display = 'none';
                }

                this.currentStep++;
                this.updateProgress();
                this.updateNavigation();

                const nextStepElement = document.querySelector(`#${this.getCurrentStepId()}`);
                if (nextStepElement) {
                    nextStepElement.style.display = 'block';
                }
            }

            previousStep() {
                if (this.currentStep > 1) {
                    const currentStepElement = document.querySelector(`#${this.getCurrentStepId()}`);
                    if (currentStepElement) {
                        currentStepElement.style.display = 'none';
                    }

                    this.currentStep--;
                    this.updateProgress();
                    this.updateNavigation();

                    const previousStepElement = document.querySelector(`#${this.getCurrentStepId()}`);
                    if (previousStepElement) {
                        previousStepElement.style.display = 'block';
                    }
                }
            }

            getCurrentStepId() {
                const stepMap = {
                    1: 'tripTypeStep',
                    2: this.planningData.tripType === 'seasonal' ? 'seasonalStep' : 
                        this.planningData.tripType === 'celebration' ? 'celebrationStep' :
                        this.planningData.tripType === 'business' ? 'businessStep' :
                        this.planningData.tripType === 'leisure' ? 'leisureStep' : 'hotelPreferencesStep',
                    3: 'hotelPreferencesStep',
                    4: 'hotelPreferencesStep',
                    5: 'hotelPreferencesStep'
                };
                return stepMap[this.currentStep] || 'tripTypeStep';
            }

            updateProgress() {
                const progressFill = document.getElementById('planningProgress');
                const currentStepSpan = document.getElementById('currentStep');
                const totalStepsSpan = document.getElementById('totalSteps');
                
                if (progressFill) {
                    const progressPercentage = (this.currentStep / this.totalSteps) * 100;
                    progressFill.style.width = `${progressPercentage}%`;
                }
                
                if (currentStepSpan) {
                    currentStepSpan.textContent = this.currentStep;
                }
                
                if (totalStepsSpan) {
                    totalStepsSpan.textContent = this.totalSteps;
                }
            }

            updateNavigation() {
                const prevBtn = document.getElementById('prevStepBtn');
                const nextBtn = document.getElementById('nextStepBtn');
                const startBtn = document.getElementById('startPlanningBtn');

                if (prevBtn) {
                    prevBtn.style.display = this.currentStep > 1 ? 'block' : 'none';
                }

                if (nextBtn) {
                    nextBtn.style.display = this.currentStep < this.totalSteps ? 'block' : 'none';
                }

                if (startBtn) {
                    startBtn.style.display = this.currentStep === this.totalSteps ? 'block' : 'none';
                }
            }

            async startInterestBasedPlanning() {
                // Create a comprehensive trip request based on user selections
                const tripRequest = this.createTripRequestFromInterests();
                
                // Add a message about the planned trip
                const message = this.createTripMessage();
                this.input.value = message;
                
                // Hide interest planning section
                document.getElementById('interestPlanningSection').style.display = 'none';
                
                // Send the message to start planning
                this.sendMessage();
            }

            createTripRequestFromInterests() {
                return {
                    trip_type: this.planningData.tripType,
                    season: this.planningData.season,
                    celebration: this.planningData.celebration,
                    business_priority: this.planningData.businessPriority,
                    leisure_interest: this.planningData.leisureInterest,
                    hotel_preference: this.planningData.hotelPreference,
                    interests: this.getInterestsArray()
                };
            }

            getInterestsArray() {
                const interests = [];
                if (this.planningData.season) interests.push(this.planningData.season);
                if (this.planningData.celebration) interests.push(this.planningData.celebration);
                if (this.planningData.businessPriority) interests.push(this.planningData.businessPriority);
                if (this.planningData.leisureInterest) interests.push(this.planningData.leisureInterest);
                if (this.planningData.hotelPreference) interests.push(this.planningData.hotelPreference);
                return interests;
            }

            createTripMessage() {
                let message = `I want to plan a `;
                
                if (this.planningData.tripType === 'seasonal') {
                    message += `${this.planningData.season} vacation`;
                } else if (this.planningData.tripType === 'celebration') {
                    message += `${this.planningData.celebration} trip`;
                } else if (this.planningData.tripType === 'business') {
                    message += `business trip with ${this.planningData.businessPriority} priority`;
                } else if (this.planningData.tripType === 'leisure') {
                    message += `${this.planningData.leisureInterest} focused trip`;
                }
                
                if (this.planningData.hotelPreference) {
                    message += ` and prefer ${this.planningData.hotelPreference} accommodation`;
                }
                
                return message;
            }

            // Add missing conversational methods for complete trip planning
            askDurationQuestion() {
                const message = `üìÖ **How many days do you want to travel?** This helps me plan the perfect itinerary length!`;
                const quickReplies = ['3-5 days', '1 week', '10 days', '2 weeks', 'Other'];
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="enhancedTravelInterface.handleDurationResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleDurationResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.trip_data.duration = response;
                
                // Ask the next question
                this.askBudgetQuestion();
            }

            askBudgetQuestion() {
                const message = `üí∞ **What's your budget preference?** This helps me find the perfect flights and hotels for you!`;
                const quickReplies = ['Budget-friendly', 'Moderate', 'Luxury', 'Tell me more'];
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="enhancedTravelInterface.handleBudgetResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleBudgetResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.trip_data.budget = response;
                
                // Show trip summary and start planning
                this.showTripSummary();
            }

            // Handle enhancement questions when basic info is complete
            askEnhancementQuestions() {
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>üéØ **Is this trip for a special occasion or just a casual getaway?**</div>
                        <div class="travel-quick-replies">
                            <button class="travel-quick-reply" onclick="enhancedTravelInterface.handleOccasionResponse('casual')">Casual getaway</button>
                            <button class="travel-quick-reply" onclick="enhancedTravelInterface.handleOccasionResponse('anniversary')">Anniversary</button>
                            <button class="travel-quick-reply" onclick="enhancedTravelInterface.handleOccasionResponse('birthday')">Birthday</button>
                            <button class="travel-quick-reply" onclick="enhancedTravelInterface.handleOccasionResponse('honeymoon')">Honeymoon</button>
                            <button class="travel-quick-reply" onclick="enhancedTravelInterface.handleOccasionResponse('business')">Business trip</button>
                            <button class="travel-quick-reply" onclick="enhancedTravelInterface.handleOccasionResponse('other')">Other special occasion</button>
                        </div>
                    </div>
                `);
            }

            handleOccasionResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.occasion = response;
                
                // Ask for interests based on occasion
                this.askInterestsQuestion(response);
            }

            askInterestsQuestion(occasion) {
                let message = `üéØ **What interests you most about this trip?**`;
                let quickReplies = [];
                
                if (occasion === 'casual') {
                    quickReplies = ['Relaxation & wellness', 'Adventure & outdoor', 'Culture & history', 'Food & dining', 'Shopping & entertainment', 'Mix of everything'];
                } else if (occasion === 'anniversary' || occasion === 'honeymoon') {
                    quickReplies = ['Romantic experiences', 'Fine dining', 'Luxury & pampering', 'Cultural exploration', 'Adventure together', 'Relaxation'];
                } else if (occasion === 'birthday') {
                    quickReplies = ['Celebration & fun', 'Adventure & excitement', 'Cultural experiences', 'Food & entertainment', 'Relaxation', 'Mix of everything'];
                } else if (occasion === 'business') {
                    quickReplies = ['Efficient logistics', 'Professional amenities', 'Cultural experiences', 'Networking opportunities', 'Relaxation after work', 'Mix of business & leisure'];
                } else {
                    quickReplies = ['Cultural exploration', 'Adventure & outdoor', 'Relaxation & wellness', 'Food & dining', 'Entertainment', 'Mix of everything'];
                }
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${message}</div>
                        <div class="travel-quick-replies">
                            ${quickReplies.map(reply => 
                                `<button class="travel-quick-reply" onclick="enhancedTravelInterface.handleInterestsResponse('${reply}')">${reply}</button>`
                            ).join('')}
                        </div>
                    </div>
                `);
            }

            handleInterestsResponse(response) {
                this.addMessage(`
                    <div class="travel-message user">
                        <div>${response}</div>
                    </div>
                `);

                // Store in conversation state
                this.conversationState.interests = [response]; // Store as array to match backend format
                
                // Now we have everything - show enhanced trip summary
                this.showEnhancedTripSummary();
            }

            showEnhancedTripSummary() {
                // Get trip data from the main conversation state, not from trip_data
                const tripData = this.conversationState;
                const summary = `üéâ **Perfect! Here's your enhanced trip summary:**

‚Ä¢ **From**: ${tripData.origin || 'Your departure city'}
‚Ä¢ **To**: ${tripData.destination || 'Your destination'}
‚Ä¢ **Travelers**: ${tripData.travelers || 'Your travel companions'}
‚Ä¢ **When**: ${tripData.start_date || 'Your selected dates'}${tripData.duration_days ? ` for ${tripData.duration_days} days` : ''}
‚Ä¢ **Budget**: ${tripData.budget_range || 'Your budget preference'}
‚Ä¢ **Occasion**: ${tripData.occasion || 'Your trip purpose'}
‚Ä¢ **Interests**: ${tripData.interests ? tripData.interests.join(', ') : 'Your travel preferences'}

Now let me craft your perfect personalized itinerary! üöÄ`;
                
                this.addMessage(`
                    <div class="travel-message ai">
                        <div>${summary}</div>
                        <div style="margin-top: 16px;">
                            <button class="travel-quick-reply primary" onclick="enhancedTravelInterface.startEnhancedTripPlanning()">
                                üéØ Start Planning My Perfect Trip
                            </button>
                        </div>
                    </div>
                `);
            }

            startEnhancedTripPlanning() {
                // Hide the conversational interface
                document.getElementById('conversationalInterests').style.display = 'none';
                
                // Create a comprehensive natural language message
                const tripData = this.conversationState;
                const message = `I want to plan a trip from ${tripData.origin} to ${tripData.destination} for ${tripData.travelers} starting ${tripData.start_date} for ${tripData.duration_days} days with a ${tripData.budget_range} budget. This is for a ${tripData.occasion} and I'm interested in ${tripData.interests ? tripData.interests.join(', ') : 'general travel'}.`;
                
                // Set the message in the input and send it
                this.input.value = message;
                this.sendMessage();
                
                // Don't clear conversation state - preserve it for potential retries
                // this.conversationState = null;
            }
        }

        // Initialize the enhanced travel interface
        const enhancedTravelInterface = new EnhancedTravelInterface();
    </script>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
